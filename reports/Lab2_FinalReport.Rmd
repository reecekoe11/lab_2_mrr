---
title: "Lab2_FinalReport"
author: "Mariah Meehan, Reece Koe, Ria Mahajan"
date: "8/4/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r install packages and libraries read in data, include=FALSE}
install.packages('corrplot')
install.packages(c('ggplot2','gganimate','gifski'))

library(dplyr) 
library(corrplot)
library(plotly)
library(ggplot2)
library(lubridate)
library(tidyverse)
library(lubridate)
library(glue)
library(leaflet)
library(readxl)
library(stargazer)
library(RCurl)
library(gganimate)



#read final dfs from github
summarized_df <- read.csv("./data/processed/summarized.csv")
covid_df <- read.csv('./data/external/us-counties.csv')
final_df <- read.csv('./data/processed/final_df.csv')
```
# Introduction
We are a group of data scientists looking to plan our next vacation. We know that over the last year with COVID, prices of rentals like Airbnb have been all over the place. We are interested in seeing how varying levels of reported COVID cases have affected price of Airbnb rentals over the last year in hopes that it will inform what we can expect for a summer vacation rental.

## Research Question
The research question we will explore in this report is as follows: How have the price of AirBnB rentals in Los Angeles and New York been affected with varying availability and COVID-19 case counts?
### Hypotheses
The null hypothesis for our research question is that there is no relationship between price of Airbnb rentals and reported covid cases.


## Inital EDA
We started by looking at the distribution of COVID cases across all U.S. counties over the past year. The distribution was left skewed but after a log transformation we were able to produce a more normal plot.
```{r EDA Mariah, warning = FALSE, echo = FALSE}
ggplot(covid_df, aes(cases)) +
  geom_histogram(bins = 30, aes(y = ..density..), fill = "red") + 
  geom_density(alpha = 0.2, fill = "red") +
  ggtitle("Transformed distribution of cases",
          subtitle = expression("With" ~'log'[10] ~ "transformation of x-axis")) +
  #theme(axis.title = element_text(), axis.title.x = element_text()) +
  geom_vline(xintercept = round(mean(covid_df$cases), 2), size = 2, linetype = 3) +
  scale_x_log10() +
  annotate("text", x = 1800, y = 0.75,label = paste("Mean Cases = ", paste0(round(mean(covid_df$cases), 2))),
           color =  "#32CD32", size = 8)
```
We then cut our analysis down to 5 cities and combined the data for Airbnb listings and COVID cases/deaths for each of the 5 cities. We discovered that New York and California had the highest number of cases and number of reviews of Airbnbs (or stays for purposes of this report) so we decided those two might be the most interesting to study.
```{r static comparison graphs, warning = FALSE, echo= FALSE}
#graph num reviews
summarized_df %>% ggplot(aes(Year.Month,Num_reviews,color=State,group = State))+geom_line()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_vline(xintercept = "2020-01",linetype = "dotted", color = "red", size = 1.5)+annotate(geom = "vline",xintercept = "2020-01",linetype="dashed")+annotate(geom = "text",label="Month COVID-19 first arrived in US",x = "2020-01",y =25000, vjust =1,hjust= -.05,color = "red")

#graph num cases
summarized_df %>% ggplot(aes(Year.Month,Num_cases/1000,color=State,group = State))+geom_line()+ylab("Number of Cases (Thosands)")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_vline(xintercept = "2020-01",linetype = "dotted", color = "red", size = 1.5)+annotate(geom = "vline",xintercept = "2020-01",linetype="dashed")+annotate(geom = "text",label="Month COVID-19 first arrived in US",x = "2020-01",y =25000, vjust =1,hjust= -.05,color = "red")
```
We also took a look at the number of cases and number of reviews over time for each of these 5 cities.
```{r animated graphs, warning= FALSE, echo = FALSE}
formatted_df_num_cases <- summarized_df %>% group_by(Year,Month) %>% mutate(rank = rank(-Num_cases),Value_rel = Num_cases/Num_cases[rank==1],Value_lbl = paste0(" ",round(Num_cases))) %>% group_by(State) %>% ungroup()


static = ggplot(formatted_df_num_cases,aes(rank,group=State,fill= State,color = State)) +geom_tile(aes(y = Num_cases/2, height = Num_cases, width = 0.9), alpha = 0.8, color = NA) +geom_text(aes(y=0,label = paste(State," ")),vjust=0.2,hjust=1)+ geom_text(aes(y=Num_cases,label = paste0(" ",round(Num_cases))), hjust=0) + coord_flip(clip = "off", expand = FALSE) +scale_y_continuous(labels = scales::comma) + scale_x_reverse() + guides(color = "none", fill = "none") +theme(axis.line=element_blank(),axis.text.x=element_blank(),axis.text.y=element_blank(), axis.ticks=element_blank(),axis.title.x=element_blank(),axis.title.y=element_blank(),legend.position="none", panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.grid.major.x = element_line( size=.1, color="grey" ),
        panel.grid.minor.x = element_line( size=.1, color="grey" ),
        plot.title=element_text(size=19, hjust=0.5, face="bold", colour="grey", vjust=1),
        plot.subtitle=element_text(size=18, hjust=0.5, face="italic", color="grey"),
        plot.caption =element_text(size=8, hjust=0.5, face="italic", color="grey"),
        plot.background=element_blank(),
       plot.margin = margin(2,2, 2, 4, "cm"))
anim_num_cases <- static + transition_states(Year.Month,transition_length = 4,state_length =4) + view_follow(fixed_x = TRUE)+labs(title = 'COVID cases per Year and Month: {closest_state}', caption  = "COVID-19 cases per Year and Month",subtitle = "5 Vacation Options")

animate(anim_num_cases)


#animated bar chart of Num Reviews
formatted_df_num_reviews <- summarized_df %>% group_by(Year,Month) %>% mutate(rank = rank(-Num_reviews),Value_rel = Num_reviews/Num_reviews[rank==1],Value_lbl = paste0(" ",round(Num_reviews))) %>% group_by(State) %>% ungroup()

static_reviews = ggplot(formatted_df_num_reviews,aes(rank,group=State,fill= State,color = State)) +geom_tile(aes(y = Num_reviews/2, height = Num_reviews, width = 0.9), alpha = 0.8, color = NA) +geom_text(aes(y=0,label = paste(State," ")),vjust=0.2,hjust=1)+ geom_text(aes(y=Num_reviews,label = paste0(" ",round(Num_reviews))), hjust=0) + coord_flip(clip = "off", expand = FALSE) +scale_y_continuous(labels = scales::comma) + scale_x_reverse() + guides(color = "none", fill = "none") +theme(axis.line=element_blank(),axis.text.x=element_blank(),axis.text.y=element_blank(), axis.ticks=element_blank(),axis.title.x=element_blank(),axis.title.y=element_blank(),legend.position="none", panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.grid.major.x = element_line( size=.1, color="grey" ),
        panel.grid.minor.x = element_line( size=.1, color="grey" ),
        plot.title=element_text(size=19, hjust=0.5, face="bold", colour="grey", vjust=1),
        plot.subtitle=element_text(size=18, hjust=0.5, face="italic", color="grey"),
        plot.caption =element_text(size=8, hjust=0.5, face="italic", color="grey"),
        plot.background=element_blank(),
       plot.margin = margin(2,2, 2, 4, "cm"))

anim_reviews <- static_reviews + transition_states(Year.Month,transition_length = 4,state_length =4) + view_follow(fixed_x = TRUE)+labs(title = 'Airbnb Reviews per Year and Month: {closest_state}',subtitle = "5 Vacation Options" ,caption  = "Number of Airbnb Reviews per Year and Month")

animate(anim_reviews)
```
# Model Building
In our model building process, we wanted to measure the price of Airbnb rentals and how they could have been affected by factors related to the rental and COVID-19 in the area. There are 3 models that we found important when answering these questions. They are as follows:

## Limited Model
For our limited model, we used the variables representing number of reviews, availability in the next 30 days and number of deaths in the last 30 days. This model resulted in a very low correlation between the variables, even with the data transformations.  These results are displayed below in the regression table. We believe that more covariates are required to predict the price of a rental than just the influence of the COVID-19 deaths and the availability. 

``` {r limited model}
limited_model <- lm(log_price  ~ deaths_30 + log(num_reviews) + availability_30, final_df)
```

## Relevant Model
This model included the key explanatory variables and covariates that we believed would be able to answer our research question. These variables included the host’s ‘superhost’ status, number of bedrooms, number of people the rental accommodates, availability in the next 30 days, average overall rating, average cleanliness rating, average location rating, average value rating, number of reviews, number of new COVID cases in the last 30 days, number of deaths in the last 30 days and OHE value for state. This model produced fairly accurate results with only the key explanatory variables and covariates that we believed would be important in predicting the price of a rental. These results are displayed below in the regression table.

``` {r relevant model}
relevant_model <- lm(log_price ~ log(bedrooms) + log(accommodates) + availability_30  + exp(review_scores_rating)  + exp(review_scores_location)  + log(num_reviews) + cases_30  + deaths_30 + NY_OHE, final_df) 
```

## Full Model
This model included all of the numeric variables that were included in the datasets (except for longitude and latitude). This model actually turned out to be almost as accurate as the `Relevant Model` explained above. Our interpretation of these results are explained in more depth in the Limitations Section below. 


``` {r full model}
full_model <- lm(log_price ~ host_is_superhost + log(bedrooms) + log_beds + log(accommodates) + availability_30 +  availability_60 + availability_90 + availability_365 + exp(review_scores_rating) + exp(review_scores_accuracy) + exp(review_scores_cleanliness)  + exp(review_scores_checkin) + exp(review_scores_communication) + exp(review_scores_location) + exp(review_scores_value) + log(num_reviews) + cases_30 + deaths_30 + cases_60 + deaths_60 + cases_90 + deaths_90 + NY_OHE, final_df) 
```



``` {r model results}
stargazer(limited_model, relevant_model, full_model, column.labels = c("Limited", "Relevant", "Full"), out ='regression_table.html', type='text', title= 'Regression Table', single.row = TRUE,  column.sep.width = "-15pt" )
```

# Limitations of Our Models

##CLM Assumption Evaluations
### IID Sampling
Each observation in our final data frame represents a listing. Some of the variables relating to a single observation might be correlated to one another, for example the price in one neighborhood may be related to or influenced by the price of listings in the same neighborhood. In order to circumvent this we decided to pull a random sample from the data we collected in order to ensure a more IID sample. We randomly selected 60% of the data to run our regression on. 

### Linear Conditional Expectation
This plot below shows the linearity of the data
``` {r model plot 1 }
plot(relevant_model,1)
```
To show linearity, we want to see a horizontal red line that represents an equal distribution of the residuals. There is also no shown pattern of the points on the graph, which proves linearity in the data.

### Normally Distributed Errors
``` {r model plot 2}
plot(relevant_model,2)
```

The plot above shows the normality of the residuals. The points of the line fall on or close to the diagonal. This is a check for normally distributed errors. 



## Limitations of the analysis
The initial reasoning behind this research question was to see if price fluctuated with the number of cases and availability of the rental properties. This question was formulated based on the assumption that there would be a wide range of the variable `last_scrapped_date`. This variable represented the last time the data was scraped and updated. It turned out that there were only a handful of different inputs in this variable, so a lot of the data had the same values for the COVID-19 related fields. This limitation in the data caused the appended values from the COVID-19 data almost irrelevant in the regression. 
The lack of variance for the COVID-19 portion of the dataset explains why the ‘full_model’ performed better than the ‘relevant_model’. Our intuition tells us that the Airbnb data dominated the coefficients created by the model. When adding more variables to the equation, it should dilute the relevant covariates in the equation and pull away from the accuracy, but that was not the case in our model. It pulled away the inaccuracy of the COVID-19 related covariates and allowed the variables taken from the Airbnb dataset to hold more weight in the regression. 



# Conclusion

The results of the model did not reflect our initial hypothesis. As we developed the research question, we established certain variables that we believed would have a strong influence on the outcome of the model. When analyzing the estimates of the model, it is obvious that a lot of the variables are not relevant in the overall equation. The most interesting finding is when looking at the estimate for the variable ‘NY_OHE’. In the `Relevant Model`, this covariate was not a strong indicator of the outcome with a value of `-0.981`. But, in the `Full Model` this variable controlled most of the result with a value of `10.97`. 
Overall, our analysis shows a relationship between a property's price and it’s availability and COVID-19’s impact. This relationship is shown through the adjusted `R^2` values of the models and the graphs that verify the assumptions needed. While there were some limitations within the data that was collected, this study could be applied to a more diverse dataset and should hold just as well, if not better. 


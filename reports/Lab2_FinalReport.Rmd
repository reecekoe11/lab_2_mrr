---
title: "Lab2_FinalReport"
author: "Mariah Meehan, Reece Koe, Ria Mahajan"
date: "8/4/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r install packages and libraries read in data, include=FALSE}
library(dplyr) 
library(corrplot)
library(plotly)
library(ggplot2)
library(lubridate)
library(tidyverse)
library(lubridate)
library(glue)
library(leaflet)
library(readxl)
library(stargazer)
library(RCurl)
library(gganimate)


setwd("/Users/rkoe/Desktop/lab_2_mrr")
#read final dfs 
summarized_df <- read_csv('data/processed/summarized_df.csv')
covid_df <- read_csv('data/external/us-counties.csv')
final_df <- read_csv('data/processed/final_df.csv')
data_NYC <- read_csv('data/external/listingsNY.csv')
data_LA <- read_csv('data/external/listingsLA.csv')
```

# Introduction
We are a group of data scientists looking to plan our next vacation. We know that over the last year with COVID, prices of rentals like Airbnb have been all over the place. We are interested in seeing how varying levels of reported COVID cases have affected price of Airbnb rentals over the last year in hopes that it will inform what we can expect for a summer vacation rental.

## Research Question
The research question we will explore in this report is as follows: How have the price of AirBnB rentals in Los Angeles and New York been affected with varying availability and COVID-19 case counts?

### Hypotheses
The null hypothesis for our research question is that there is no relationship between price of Airbnb rentals and reported covid cases. The alternate hypothesis is that cases do have an effect on price.

# Exploratory Data Analysis

We started by looking at the distribution of COVID cases across all U.S. counties over the past year. The distribution was left skewed but after a log transformation we were able to produce a more normal plot.

```{r EDA Mariah, warning = FALSE, echo = FALSE}
ggplot(covid_df, aes(cases)) +
  geom_histogram(bins = 30, aes(y = ..density..), fill = "red") + 
  geom_density(alpha = 0.2, fill = "red") +
  ggtitle("Transformed distribution of cases",
          subtitle = expression("With" ~'log'[10] ~ "transformation of x-axis")) +
  #theme(axis.title = element_text(), axis.title.x = element_text()) +
  geom_vline(xintercept = round(mean(covid_df$cases), 2), size = 2, linetype = 3) +
  scale_x_log10() +
  annotate("text", x = 1800, y = 0.75,label = paste("Mean Cases = ", paste0(round(mean(covid_df$cases), 2))),
           color =  "#32CD32", size = 8)
```
We then cut our analysis down to 5 cities and combined the data for Airbnb listings and COVID cases/deaths for each of the 5 cities. We discovered that New York and California had the highest number of cases and number of reviews of Airbnbs (or stays for purposes of this report) so we decided those two might be the most interesting to study. We also took a look at the number of cases and number of reviews over time for each of these 5 cities. *See cleaning file for animated graphs.*


```{r static comparison graphs, warning = FALSE, echo= FALSE, fig.height= 3}
#graph num reviews
summarized_df %>% ggplot(aes(Year.Month,Num_reviews,color=State,group = State))+geom_line()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_vline(xintercept = "2020-01",linetype = "dotted", color = "red", size = 1.5)+annotate(geom = "vline",xintercept = "2020-01",linetype="dashed")+annotate(geom = "text",label="Month COVID-19 first arrived in US",x = "2020-01",y =25000, vjust =1,hjust= -.05,color = "red")

#graph num cases
summarized_df %>% ggplot(aes(Year.Month,Num_cases/1000,color=State,group = State))+geom_line()+ylab("Number of Cases (Thosands)")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_vline(xintercept = "2020-01",linetype = "dotted", color = "red", size = 1.5)+annotate(geom = "vline",xintercept = "2020-01",linetype="dashed")+annotate(geom = "text",label="Month COVID-19 first arrived in US",x = "2020-01",y =25000, vjust =1,hjust= -.05,color = "red")
```




## Variables

### Price
Airbnb pricing strategy is a key player in your Airbnb business. You must make 
sure the price defines the maximum value of the product and at the same time it 
must appeal to the customers. The direct impact of your Airbnb pricing is the 
number of bookings you receive. Pricing is probably the first detail that a 
potential guest will notice. After narrowing our city selection down to New York
City and Los Angeles, we wanted to dive in deeper to see the distribution of what
Airbnb’s are being rented out for. Our initial approach of just plotting price 
did not give us an accurate reading. After looking at the distribution of the 
price variable, we performed a logarithmic transformation because the distribution
was skewed to the right. The mean price for an Airbnb in New York City is $157.05 
as compared to in Los Angeles where the mean is $260.65 across all different room 
type options. 



```{r New York City- Price, echo=FALSE, warning=FALSE, fig.height= 3}
ggplot(data_NYC, aes(price)) +
  geom_histogram(bins = 30, aes(y = ..density..), fill = "purple") + 
  geom_density(alpha = 0.2, fill = "purple") +
  ggtitle("Distribution of price",
          subtitle = "The distribution is very skewed") +
  theme(axis.title = element_text(), axis.title.x = element_text()) +
  geom_vline(xintercept = round(mean(data_NYC$price), 2), size = 2, linetype = 3)
#Since the original distribution is very skewed, logarithmic transformation can be used to gain better insight into data.
ggplot(data_NYC, aes(price)) +
  geom_histogram(bins = 30, aes(y = ..density..), fill = "purple") + 
  geom_density(alpha = 0.2, fill = "purple") +
  ggtitle("Transformed distribution of price",
          subtitle = expression("With" ~'log'[10] ~ "transformation of x-axis")) +
  #theme(axis.title = element_text(), axis.title.x = element_text()) +
  geom_vline(xintercept = round(mean(data_NYC$price), 2), size = 2, linetype = 3) +
  scale_x_log10() +
  annotate("text", x = 1800, y = 0.75,label = paste("Mean price = ", paste0(round(mean(data_NYC$price), 2), "$")),
           color =  "#32CD32", size = 8)
```


```{r Los Angeles - Price Distribution, echo=FALSE, warning=FALSE }
#Since the original distribution is very skewed, logarithmic transformation can be used to gain better insight into data.
ggplot(data_LA, aes(price)) +
  geom_histogram(bins = 30, aes(y = ..density..), fill = "purple") + 
  geom_density(alpha = 0.2, fill = "purple") +
  ggtitle("Transformed distribution of price",
          subtitle = expression("With" ~'log'[10] ~ "transformation of x-axis")) +
  #theme(axis.title = element_text(), axis.title.x = element_text()) +
  geom_vline(xintercept = round(mean(data_LA$price), 2), size = 2, linetype = 3) +
  scale_x_log10() +
  annotate("text", x = 1800, y = 0.75,label = paste("Mean price = ", paste0(round(mean(data_LA$price), 2), "$")),
           color =  "#32CD32", size = 8)
```


### Availability
Airbnb has experienced a series of changes on to adapt for what it believes will 
be a new travel reality: People booking longer trips, or even living away from 
home for months. It’s a big change from before, when it was all about business 
trips or brief vacations during specific times of the year like summer. 
According to Airbnb, as of February 2021, a mix of mountain and coastal locations
gained the most number of new available listings, which are defined as the 
number of active listings (the number of listings viewable on Airbnb with at 
least one prior booked night) that have calendar availability or at least one 
booked day in the month. For our analysis as we were looking at New York City 
and Los Angeles data, we decided this would be an important variable to keep 
into consideration for our model as instead of using the original variable 
availiabilty_365, we now could view availability within a 30-, 60-, and 
90-day period. Based off of the varying ability, we can see how price would be 
affected as Airbnb increased its flexibility as COVID-19 case counts fluctuated.
According to Airbnb, demand for short-term rentals is expected to show a significant
recovery in 2021 as vaccines continue to roll out and pent-up demand accelerates 
booking globally.


### Neighborhood
Although neighborhood was not a factor we used in our final model, for our 
preliminary data collection the neighborhood an Airbnb is in plays a big role. 
As part of the Inside Airbnb dataset, one column that our group wanted to explore
was neighbourhood_group and neighbourhood. When performing our initial data 
cleaning and finding unique values, we saw that New York City is divided into 
5 main groups which include Bronx, Brooklyn, Manhattan, Queens, and Staten Island. 
As you can see below, Manhattan has the highest percentage of listings among 
the other neighborhoods. Brooklyn also possess several listings that is almost 
similar to Manhattan. The other neighborhoods have considerably less percentages. 
Based on these findings we can assume this since Manhattan and Brooklyn are 
highly commercialized cities. Also, Manhattan is known to have the highest population. To accommodate a larger number of people, the number of houses should be 
high hence explains the reason for having the highest percentage of listings. 
Additionally, when looking at the mean price breakdown by the neighborhood group, 
we can see Manhattan having the highest price at $201.91 followed by Brooklyn 
at $128.78. 



```{r Mean Price comparison for each Neighbourhood Group - NY, echo=FALSE, warning=FALSE}
data_NYC %>% 
  filter(!(is.na(neighbourhood_group))) %>% 
  filter(!(neighbourhood_group == "Unknown")) %>% 
  group_by(neighbourhood_group) %>% 
  summarise(mean_price = mean(price, na.rm = TRUE)) %>% 
  ggplot(aes(x = reorder(neighbourhood_group, mean_price), y = mean_price, fill = neighbourhood_group)) +
  geom_col(stat ="identity", color = "black", fill="#357b8a") +
  coord_flip() +
  theme_gray() +
  labs(x = "Neighbourhood Group", y = "Price") +
  geom_text(aes(label = round(mean_price,digit = 2)), hjust = 2.0, color = "white", size = 3.5) +
  ggtitle("Mean Price comparison for each Neighbourhood Group - NY", subtitle = "Price vs Neighbourhood Group") + 
  xlab("Neighbourhood Group") + 
  ylab("Mean Price") +
  theme(legend.position = "none",
        plot.title = element_text(color = "black", size = 14, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(color = "darkblue", hjust = 0.5),
        axis.title.y = element_text(),
        axis.title.x = element_text(),
        axis.ticks = element_blank())
```


```{r Mean Price comparison for each Neighbourhood Group - LA, echo=FALSE, warning=FALSE}
data_LA %>% 
  filter(!(is.na(neighbourhood_group))) %>% 
  filter(!(neighbourhood_group == "Unknown")) %>% 
  group_by(neighbourhood_group) %>% 
  summarise(mean_price = mean(price, na.rm = TRUE)) %>% 
  ggplot(aes(x = reorder(neighbourhood_group, mean_price), y = mean_price, fill = neighbourhood_group)) +
  geom_col(stat ="identity", color = "black", fill="#357b8a") +
  coord_flip() +
  theme_gray() +
  labs(x = "Neighbourhood Group", y = "Price") +
  geom_text(aes(label = round(mean_price,digit = 2)), hjust = 2.0, color = "white", size = 3.5) +
  ggtitle("Mean Price comparison for each Neighbourhood Group - LA", subtitle = "Price vs Neighbourhood Group") + 
  xlab("Neighbourhood Group") + 
  ylab("Mean Price") +
  theme(legend.position = "none",
        plot.title = element_text(color = "black", size = 14, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(color = "darkblue", hjust = 0.5),
        axis.title.y = element_text(),
        axis.title.x = element_text(),
        axis.ticks = element_blank())
```

### Total Cases
Airbnb is one of the many businesses in the travel industry that has been hit hard by the coronavirus pandemic. In March 2017 Airbnb was valued at $31 billion. By the end of April 2020 it was worth $18 billion. The global pandemic is proving to be Airbnb’s biggest challenge yet as social distancing measures are in place, some local governments deemed short-term rentals as non-essential businesses, adding more stress to hosts who rely on Airbnb for income. 


### Room Type/Bedrooms
When guests book a place, they want to know what they’ll be getting as far as 
accommodation go. The first option a guest has when it comes to renting is the 
shared rooms option. This comes with the expectation that the guests share the 
entire space with the host or others and don’t have a private room to themselves.
The second option is private rooms where the guests share some common areas with 
the host (i.e. kitchen, living room, bathroom) but they have their own private 
room for sleeping. And lastly the most popular option is having the ability to 
rent out the entire home/apartment. This allows the guests to rent the entire 
unit and don’t have to share the space with the host or with anyone else. Airbnb 
also allows for the ability to rent hotel rooms. When looking at our models below,
we can see that for both LA and NYC, entire houses and apartments is the most 
popular property type. To find the mean price for all the different room types, 
we first had to drop any values where the price was equal to zero or NULL. When 
looking at New York’s price for different room type, we see that hotel is the 
most expensive rental type at $290.76. A guest would have a better offer renting
a entire house/apartment ranging around $208.73 depending on location,
availability, and other factors we use in our model that will be mentioned later.
In comparison, when looking at the Los Angeles data, we see that entire 
homes/apartments mean price is $323.98 which is significantly higher than 
the New York City prices. 


```{r Mean Price Commaprison of Room types - NYC, echo=FALSE, warning=FALSE }
data_NYC %>% 
  filter(!(is.na(room_type))) %>% 
  filter(!(room_type == "Unknown")) %>% 
  group_by(room_type) %>% 
  summarise(mean_price = mean(price, na.rm = TRUE)) %>% 
  ggplot(aes(x = reorder(room_type, mean_price), y = mean_price, fill = room_type)) +
  geom_col(stat ="identity", color = "black", fill="#357b8a") +
  coord_flip() +
  theme_gray() +
  labs(x = "Room Type", y = "Price") +
  geom_text(aes(label = round(mean_price,digit = 2)), hjust = 2.0, color = "white", size = 3.5) +
  ggtitle("Mean Price comparison with all Room Types - NYC", subtitle = "Price vs Room Type") + 
  xlab("Room Type") + 
  ylab("Mean Price")
```


```{r Mean Price comparison for each Room Type - LA, echo=FALSE, warning=FALSE}
data_LA %>% 
  filter(!(is.na(room_type))) %>% 
  filter(!(room_type == "Unknown")) %>% 
  group_by(room_type) %>% 
  summarise(mean_price = mean(price, na.rm = TRUE)) %>% 
  ggplot(aes(x = reorder(room_type, mean_price), y = mean_price, fill = room_type)) +
  geom_col(stat ="identity", color = "black", fill="#357b8a") +
  coord_flip() +
  theme_gray() +
  labs(x = "Room Type", y = "Price") +
  geom_text(aes(label = round(mean_price,digit = 2)), hjust = 2.0, color = "white", size = 3.5) +
  ggtitle("Mean Price comparison with all Room Types - NYC", subtitle = "Price vs Room Type") + 
  xlab("Room Type") + 
  ylab("Mean Price")
```

### Other Variables
We additionally included several measures of "review" data in our model that would 
help us in the model to answer our original question: How have the price of AirBnB rentals in Los Angeles and New York been affected with varying availability and COVID-19 case counts? Reviews are essential to the entire Airbnb community, helping guests choose their travel plans wisely and enabling hosts like you to open their homes with confidence and attract guests who will love their stay. In fact, it’s not a stretch to say that your Airbnb business is based on positive reviews. Each review helps guests decide whether to book with you, and Airbnb data suggests that a higher number of positive reviews is correlated with higher price rentals. To find the number of reviews on a certain property, we had to use the ‘reviews.csv’ datasets. These included the listing ID number along with the date of review. We subset the entries for all reviews made on or after March 1, to designate our “summer” period to study. We summed the number of entries by listing ID and appended that to each observation. For the sake of our model which we will look at furhter in the report, we look at many specific categories of review data including: review_scores_rating, review_scores_accuracy, review_scores_cleanliness, and review_scores_communication to list a few.


# Model Building
In our model building process, we wanted to measure the price of Airbnb rentals and how they could have been affected by factors related to the rental and COVID-19 in the area. There are 3 models that we found important when answering these questions. They are as follows:

## Limited Model
For our limited model, we used the variables representing number of reviews, availability in the next 30 days and number of deaths in the last 30 days. This model resulted in a very low correlation between the variables, even with the data transformations.  These results are displayed below in the regression table. We believe that more covariates are required to predict the price of a rental than just the influence of the COVID-19 deaths and the availability. 

``` {r limited model}
limited_model <- lm(log_price  ~ deaths_30 + log(num_reviews) + availability_30, final_df)
```

## Relevant Model
This model included the key explanatory variables and covariates that we believed would be able to answer our research question. These variables included the host’s ‘superhost’ status, number of bedrooms, number of people the rental accommodates, availability in the next 30 days, average overall rating, average cleanliness rating, average location rating, average value rating, number of reviews, number of new COVID cases in the last 30 days, number of deaths in the last 30 days and OHE value for state. This model produced fairly accurate results with only the key explanatory variables and covariates that we believed would be important in predicting the price of a rental. These results are displayed below in the regression table.

``` {r relevant model}
relevant_model <- lm(log_price ~ log(bedrooms) + log(accommodates) + availability_30  + exp(review_scores_rating)  + exp(review_scores_location)  + log(num_reviews) + cases_30  + deaths_30 + NY_OHE, final_df) 
```

## Full Model
This model included all of the numeric variables that were included in the datasets (except for longitude and latitude). This model actually turned out to be almost as accurate as the `Relevant Model` explained above. Our interpretation of these results are explained in more depth in the Limitations Section below. 


``` {r full model}
full_model <- lm(log_price ~ host_is_superhost + log(bedrooms) + log_beds + log(accommodates) + availability_30 +  availability_60 + availability_90 + availability_365 + exp(review_scores_rating) + exp(review_scores_accuracy) + exp(review_scores_cleanliness)  + exp(review_scores_checkin) + exp(review_scores_communication) + exp(review_scores_location) + exp(review_scores_value) + log(num_reviews) + cases_30 + deaths_30 + cases_60 + deaths_60 + cases_90 + deaths_90 + NY_OHE, final_df) 
```

\newpage

``` {r model results, results='asis'}
stargazer(limited_model, relevant_model, full_model, column.labels = c("Limited", "Relevant", "Full"), title= 'Regression Table', type='html', align=TRUE )
```

# Limitations of Our Models

##CLM Assumption Evaluations
### IID Sampling
Each observation in our final data frame represents a listing. Some of the variables relating to a single observation might be correlated to one another, for example the price in one neighborhood may be related to or influenced by the price of listings in the same neighborhood. In order to circumvent this we decided to pull a random sample from the data we collected in order to ensure a more IID sample. We randomly selected 60% of the data to run our regression on. 

### Linear Conditional Expectation
This plot below shows the linearity of the data
``` {r model plot 1 }
plot(relevant_model,1)
```
To show linearity, we want to see a horizontal red line that represents an equal distribution of the residuals. There is also no shown pattern of the points on the graph, which proves linearity in the data.

### Normally Distributed Errors
``` {r model plot 2}
plot(relevant_model,2)
```

The plot above shows the normality of the residuals. The points of the line fall on or close to the diagonal. This is a check for normally distributed errors. 



## Limitations of the analysis
The initial reasoning behind this research question was to see if price fluctuated with the number of cases and availability of the rental properties. This question was formulated based on the assumption that there would be a wide range of the variable `last_scrapped_date`. This variable represented the last time the data was scraped and updated. It turned out that there were only a handful of different inputs in this variable, so a lot of the data had the same values for the COVID-19 related fields. This limitation in the data caused the appended values from the COVID-19 data almost irrelevant in the regression. 
The lack of variance for the COVID-19 portion of the dataset explains why the ‘full_model’ performed better than the ‘relevant_model’. Our intuition tells us that the Airbnb data dominated the coefficients created by the model. When adding more variables to the equation, it should dilute the relevant covariates in the equation and pull away from the accuracy, but that was not the case in our model. It pulled away the inaccuracy of the COVID-19 related covariates and allowed the variables taken from the Airbnb dataset to hold more weight in the regression. 



# Conclusion

The results of the model did not reflect our initial hypothesis. As we developed the research question, we established certain variables that we believed would have a strong influence on the outcome of the model. When analyzing the estimates of the model, it is obvious that a lot of the variables are not relevant in the overall equation. The most interesting finding is when looking at the estimate for the variable ‘NY_OHE’. In the `Relevant Model`, this covariate was not a strong indicator of the outcome with a value of `-0.981`. But, in the `Full Model` this variable controlled most of the result with a value of `10.97`. 
Overall, our analysis shows a relationship between a property's price and it’s availability and COVID-19’s impact. This relationship is shown through the adjusted `R^2` values of the models and the graphs that verify the assumptions needed. While there were some limitations within the data that was collected, this study could be applied to a more diverse dataset and should hold just as well, if not better. 

